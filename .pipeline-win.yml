stages:
  - test

default:
  tags:
    - windows
    - pn2606796

.win-job-environment: &win-job-environment
  variables:
    GIT_STRATEGY: clone
    conda_installation: "C:/ProgramData/miniconda3"
    environment_file: "environment.yml"
  before_script:
    - $PSVersionTable
    - $env:username
    - git config --list --show-origin | Select-String -Pattern "symlinks="
    - git ls-tree -r HEAD | Select-String -Pattern "^120" | Measure-Object -Line
    - Get-ChildItem -Recurse | Where-Object { $_.LinkType -eq 'SymbolicLink' } | Measure-Object -Line
    - if ([string]::IsNullOrEmpty($environment_file)) { exit 1 }
    - if ([string]::IsNullOrEmpty($conda_installation)) { exit 1 }
    # Common job variables
    - $prefix="$pwd\conda-environment"
    - $conda_pkgs_dirs="$pwd\conda-pkgs"
    - Write-Output $conda_installation
    - Write-Output $environment_file
    - Write-Output $prefix
    - Write-Output $conda_pkgs_dirs
    - if (!(Test-Path -Path $conda_installation -PathType Container)) { exit 1 }
    - if ([string]::IsNullOrEmpty($prefix)) { exit 1 }
    # Environment creation
    - $env:CONDA_PKGS_DIRS=$conda_pkgs_dirs
    - (& "$conda_installation\Scripts\conda.exe" "shell.powershell" "hook") | Out-String | ?{$_} | Invoke-Expression
    - conda info
    - conda env create --prefix $prefix --file $environment_file --yes
    - conda activate $prefix
    - conda info
    - python -c "import getpass; print(getpass.getuser())"
  after_script:
    - Remove-Item -Force -Recurse $pwd\conda-environment -ErrorAction Continue
    - Remove-Item -Force -Recurse $pwd\conda-pkgs -ErrorAction Continue

win-developer-test:
  extends:
    - .win-job-environment
  stage: test
  script: scons regression --abaqus-command='C:\SIMULIA\Commands\abq2024.bat' --cubit-command='C:\Program Files\Cubit 16.18\cubit.exe'
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  rules:
    - if: $PARENT_CI_PIPELINE_SOURCE == "schedule"
    - if: $PARENT_CI_PIPELINE_SOURCE == "merge_request_event"

win-conda-build:
  extends:
    - .win-job-environment
  stage: test
  rules:
    - if: $PARENT_CI_PIPELINE_SOURCE == "schedule"
    - if: $PARENT_CI_PIPELINE_SOURCE == "merge_request_event"
  variables:
    environment_file: "conda-build.yml"
    recipe_directory: "recipe"
  script:
    # Job variables
    - Write-Output $recipe_directory
    - if ([string]::IsNullOrEmpty($recipe_directory)) { exit 1 }
    # Job commands
    - $env:VERSION=python -m setuptools_scm
    - conda mambabuild $recipe_directory --channel conda-forge --no-anaconda-upload --croot $env:temp --output-folder conda-bld

win-pip-build:
  extends:
    - .win-job-environment
  stage: test
  rules:
    - if: $PARENT_CI_PIPELINE_SOURCE == "schedule"
    - if: $PARENT_CI_PIPELINE_SOURCE == "merge_request_event"
  variables:
    distribution_name: "turbo_turtle"
    environment_file: "pip-build.yml"
  script:
    # Job variables
    - scons pyproject.toml
    - $version=python -m setuptools_scm
    - Write-Output $version
    - if ([string]::IsNullOrEmpty($distribution_name)) { exit 1 }
    - if ([string]::IsNullOrEmpty($version)) { exit 1 }
    # Job commands
    # Conda CI environment active
    - scons build
    - twine check build/dist/$distribution_name-$version.tar.gz
    - python -m venv pip-build-test
    # Python venv environment active
    - pip-build-test\Scripts\Activate.ps1
    - python -m pip install --verbose --disable-pip-version-check --require-virtualenv --no-cache-dir build\dist\$distribution_name-$version.tar.gz pytest pytest-xdist
    - cd pip-build-test\Lib\site-packages\waves
    - python -m pytest -vvv -n 4
